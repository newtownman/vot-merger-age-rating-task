<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>한국어 TTS 음성 평가 실험</title>
  <!-- jsPsych & 플러그인 -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey@2.0.1"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <style>
    html, body, .jspsych-content, .sv-root, .sv-question__title, .sv-string-viewer, input, select, button {
      font-size: 1.25rem !important;
      line-height: 1.5 !important;
    }
    #progress-indicator {
      position: fixed;
      top: 12px;
      right: 18px;
      z-index: 9999;
      font-size: 2.2em;
      font-weight: bold;
      color: #333;
      background: rgba(255,255,255,0.8);
      padding: 2px 10px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      pointer-events: none;
      user-select: none;
    }
    .sd-action__title {
      display: none !important;
    }
    .sv-action-bar-item.sv-action-bar-item--icon.sv-dots__item {
      display: none !important;
    }
    .sd-action[title="Clear"] {
      display: none !important;
    }
    .sv-clear-button,
    .sv-dropdown__button {
      display: none !important;
    }
    .sv_q_radiogroup {
      display: block !important;
    }
    .sv_q_rating .sv-string-viewer {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="progress-indicator"></div>
</body>
<script>
  // Firebase 설정 및 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyAGhIukq-XNYvi2AN0AwNpIX7HcEiUeIRw",
    authDomain: "vot-merger-age-rating-task.firebaseapp.com",
    databaseURL: "https://vot-merger-age-rating-task-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vot-merger-age-rating-task",
    storageBucket: "vot-merger-age-rating-task.appspot.com",
    messagingSenderId: "456169777676",
    appId: "1:456169777676:web:d7b5fafc0fb3f3383e5c29",
    measurementId: "G-PNGYMT1HH8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const stimuli = [
    "1_1.wav",
    "2_1.wav",
    "3_1.wav",
    "4_1.wav",
    "5_1.wav"
  ];

  const jsPsych = initJsPsych({
    on_finish: function() {
      let trials = jsPsych.data.get().filter({trial_tag: 'audio_trial'}).values();
      trials = trials.map((trial, idx) => ({
        trial_number: idx,
        audio_file: trial.audio_file,
        age: trial.age,
        region: trial.region,
        machine: trial.machine
      }));

      const account_trial = jsPsych.data.get().filter({trial_tag: 'account_info'}).last(1).values()[0];
      const account_number = account_trial ? account_trial.account_number || null : null;

      db.ref('responses').push({
        trials: trials,
        account_number: account_number,
        timestamp: new Date().toISOString()
      });
    }
  });

  const total_trials = stimuli.length;

  const intro = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>설문 안내</h2>
      <p>본 설문은 한국어의 여러 사회적 지표와 관련된 음성 변이를 TTS에서 탐
