<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>한국어 TTS 음성 평가 실험</title>
  <!-- jsPsych & 플러그인 -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey@2.0.1"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <style>
    .sv-clear-button,
    .sv-dropdown__button {
      display: none !important;
    }
    .sv_q_radiogroup {
      display: block !important;
    }
    .sv_q_rating .sv-string-viewer {
      display: none !important;
    }
  </style>
</head>
<body></body>
<script>
  // 1. Firebase 설정 및 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyAGhIukq-XNYvi2AN0AwNpIX7HcEiUeIRw",
    authDomain: "vot-merger-age-rating-task.firebaseapp.com",
    databaseURL: "https://vot-merger-age-rating-task-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vot-merger-age-rating-task",
    storageBucket: "vot-merger-age-rating-task.firebasestorage.app",
    messagingSenderId: "456169777676",
    appId: "1:456169777676:web:d7b5fafc0fb3f3383e5c29",
    measurementId: "G-PNGYMT1HH8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // 2. jsPsych 초기화 (on_finish에서 Firebase에만 저장)
  const jsPsych = initJsPsych({
    on_finish: function() {
      const data = jsPsych.data.get().csv();
      db.ref('responses').push({
        csv: data,
        timestamp: new Date().toISOString()
      });
      // csv 다운로드/표시 없음
    }
  });

  // 안내멘트(시작)
  const intro = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <h2>설문 안내</h2>
      <p>본 설문은 한국어의 여러 사회적 지표와 관련된 음성 변이를 TTS에서 탐구하기 위한 것입니다.<br>
      음성 파일을 재생하고, 해당 음성의 연령대 및 지역과 기계적인 정도를 평가해주시면 됩니다.</p>
      <p>스페이스바를 누르면 시작합니다.</p>
    `,
    choices: [' ']
  };

  // 오디오 파일 리스트
  const stimuli = [
    "nof_선경_1.wav","nof_선희_1.wav","nof_유진_1.wav","nof_진아_1.wav","nof_희그리다_1.wav",
    "nom_김종억_1.wav","nom_수아아빠_1.wav","nom_코말소_1.wav",
    "nyf_기서_1.wav","nyf_민영_1.wav","nyf_소현_1.wav","nyf_루나_1.wav","nyf_지요_1.wav",
    "nym_대성_1.wav","nym_동현_1.wav","nym_이안_1.wav","nym_종혁_1.wav","nym_최루비_1.wav",
    "tof_선영_1.wav","tof_순이_1.wav","tof_인선_1.wav","tof_정순_1.wav","tof_주하_1.wav",
    "tom_덕춘_1.wav","tom_덕환_1.wav","tom_영길_1.wav","tom_종현_1.wav","tom_창배_1.wav",
    "tyf_세희_1.wav","tyf_시연_1.wav","tyf_예린_1.wav","tyf_유라_1.wav","tyf_이나_1.wav",
    "tym_김건_1.wav","tym_서준_1.wav","tym_지훈_1.wav","tym_진우_1.wav","tym_현우_1.wav"
  ];

  const shuffled = jsPsych.randomization.shuffle(stimuli);

  let timeline = [];
  timeline.push(intro);

  shuffled.forEach((audiofile, idx) => {
    const survey_json = {
      elements: [
        {
          type: "html",
          name: "audio_" + idx,
          html: `
            <p><b>아래 음성 파일을 들어보세요.</b></p>
            <audio controls>
              <source src="${audiofile}" type="audio/wav">
              브라우저가 오디오 태그를 지원하지 않습니다.
            </audio>
            <hr>
          `
        },
        {
          type: "text",
          name: "age_" + idx,
          title: "화자의 목소리는 몇 살처럼 들리십니까? (10~99 사이의 숫자를 입력)",
          inputType: "number",
          min: 10,
          max: 99,
          isRequired: true
        },
        {
          type: "radiogroup",
          name: "region_" + idx,
          title: "화자는 어느 지역 출신처럼 들리십니까?",
          choices: ["서울", "경상", "전라", "충청"],
          isRequired: true,
          showClearButton: false,
          showOtherItem: false,
          colCount: 1
        },
        {
          type: "rating",
          name: "machine_" + idx,
          title: "화자는 얼마나 기계음, 합성음처럼 들립니까?",
          rateMin: 0,
          rateMax: 4,
          isRequired: true,
          minRateDescription: "",
          maxRateDescription: ""
        }
      ]
    };

    timeline.push({
      type: jsPsychSurvey,
      survey_json: survey_json,
      button_label_finish: "다음"
    });
  });

  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <h2>설문 완료</h2>
      <p>고생하셨습니다.<br>
      <b>zaqs1578@pusan.ac.kr</b>로 계좌와 함께 설문 후에 나온 csv 파일을 보내주시면 되겠습니다.</p>
      <p>스페이스바를 누르면 종료됩니다.</p>
    `,
    choices: [' ']
  });

  jsPsych.run(timeline);
</script>
</html>
